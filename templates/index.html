<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask Primer App</title>
    <!-- Include Primer CSS -->
    <link href="https://unpkg.com/@primer/css@^20.2.4/dist/primer.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .claude-highlight {
            outline: 3px solid #f1c40f !important;
            background-color: rgba(241, 196, 15, 0.3) !important;
            transition: all 0.3s ease !important;
            position: relative !important;
            z-index: 10000 !important;
        }

        @keyframes pulse {
            0% { outline-color: rgba(241, 196, 15, 1); }
            50% { outline-color: rgba(241, 196, 15, 0.5); }
            100% { outline-color: rgba(241, 196, 15, 1); }
        }

        .claude-highlight {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container-lg px-3 my-3 markdown-body">
        <div class="d-flex flex-row full-height">
            <!-- Left Panel - increased from 20% to 35% -->
            <div class="Box p-4 mr-3" style="width: 35%;">
                <h1 class="h3 mb-3">URL Opener</h1>
                <div class="form-group">
                    <div class="input-group">
                        <input type="text" class="form-control" id="urlInput" 
                               placeholder="Enter URL">
                        <button class="btn btn-primary ml-2" onclick="loadURL()">Open</button>
                    </div>
                </div>
                
                <!-- Classes Panel -->
                <div class="classes-panel">
                    <h2 class="h4 mb-2">Page Classes</h2>
                    <div class="Box">
                        <div class="Box-header">
                            <h3 class="Box-title">Found Classes</h3>
                            <span id="classCount" class="Counter">0</span>
                        </div>
                        <div id="classesList" class="Box-body overflow-auto" style="max-height: 70vh;">
                            <div class="blankslate">
                                <p>Load a page to see classes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - decreased from 80% to 65% -->
            <div class="Box p-3" style="width: 65%;">
                <iframe id="urlFrame" width="100%" 
                        src="about:blank" 
                        frameborder="0"
                        sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                        onerror="handleFrameError()"></iframe>
                <div id="errorMessage" class="flash flash-error mt-3" style="display: none;">
                    This website cannot be displayed in an iframe due to security restrictions.
                    <a id="directLink" href="#" target="_blank" class="btn btn-sm ml-2">Open in New Tab</a>
                </div>
                <div id="loadingMessage" class="flash flash-warn mt-3" style="display: none;">
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <script>
        function handleFrameError() {
            showError();
        }

        function showError() {
            const frame = document.getElementById('urlFrame');
            const errorMsg = document.getElementById('errorMessage');
            const loadingMsg = document.getElementById('loadingMessage');
            
            frame.src = 'about:blank';
            errorMsg.style.display = 'block';
            loadingMsg.style.display = 'none';
        }

        function extractClasses(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const classInfo = new Map();
            
            doc.querySelectorAll('*').forEach(element => {
                element.classList.forEach(className => {
                    if (!classInfo.has(className)) {
                        classInfo.set(className, {
                            count: 0,
                            texts: new Set()
                        });
                    }
                    const info = classInfo.get(className);
                    info.count++;
                    
                    const text = element.textContent.trim();
                    if (text && text.length < 100) {
                        info.texts.add(text);
                    }
                });
            });
            
            return Array.from(classInfo.entries())
                .filter(([_, info]) => {
                    return info.count > 1 && info.texts.size > 0;
                })
                .sort((a, b) => {
                    if (b[1].count !== a[1].count) {
                        return b[1].count - a[1].count;
                    }
                    return a[0].localeCompare(b[0]);
                })
                .map(([className, info]) => ({
                    name: className,
                    count: info.count,
                    texts: Array.from(info.texts)
                }));
        }

        function injectStyles(frameDoc) {
            const style = frameDoc.createElement('style');
            style.textContent = `
                .claude-highlight {
                    outline: 3px solid #f1c40f !important;
                    background-color: rgba(241, 196, 15, 0.3) !important;
                    transition: all 0.3s ease !important;
                    position: relative !important;
                    z-index: 10000 !important;
                    animation: pulse 2s infinite !important;
                }

                @keyframes pulse {
                    0% { outline-color: rgba(241, 196, 15, 1); }
                    50% { outline-color: rgba(241, 196, 15, 0.5); }
                    100% { outline-color: rgba(241, 196, 15, 1); }
                }
            `;
            frameDoc.head.appendChild(style);
        }

        function highlightElements(className) {
            try {
                const frame = document.getElementById('urlFrame');
                const frameDoc = frame.contentDocument || frame.contentWindow.document;
                
                // Inject styles if they don't exist
                if (!frameDoc.querySelector('style')) {
                    injectStyles(frameDoc);
                }
                
                // Remove previous highlights
                const previousHighlights = frameDoc.querySelectorAll('.claude-highlight');
                previousHighlights.forEach(el => {
                    el.classList.remove('claude-highlight');
                    el.style.removeProperty('z-index');
                });
                
                // Add new highlights
                const elements = frameDoc.getElementsByClassName(className);
                if (elements.length > 0) {
                    Array.from(elements).forEach(el => {
                        el.classList.add('claude-highlight');
                        el.style.zIndex = '10000';
                    });
                    
                    // Scroll first element into view
                    elements[0].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    console.log(`Highlighted ${elements.length} elements with class ${className}`);
                } else {
                    console.log(`No elements found with class ${className}`);
                }
            } catch (e) {
                console.error('Error highlighting elements:', e);
            }
        }

        function toggleClassContent(className) {
            const contentDiv = document.getElementById(`content-${className}`);
            const arrow = document.getElementById(`arrow-${className}`);
            
            if (contentDiv.style.display === 'none' || !contentDiv.style.display) {
                contentDiv.style.display = 'block';
                arrow.innerHTML = '▼';
                highlightElements(className);
            } else {
                contentDiv.style.display = 'none';
                arrow.innerHTML = '▶';
                // Remove highlights when closing
                try {
                    const frame = document.getElementById('urlFrame');
                    const doc = frame.contentDocument || frame.contentWindow.document;
                    const elements = doc.getElementsByClassName(className);
                    Array.from(elements).forEach(el => {
                        el.classList.remove('claude-highlight');
                        el.style.removeProperty('z-index');
                    });
                } catch (e) {
                    console.error('Cannot access iframe content:', e);
                }
            }
        }

        function escapeXml(unsafe) {
            return unsafe
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        function downloadAsRss(className, textsArray) {
            try {
                // Get current date in RFC 822 format
                const pubDate = new Date().toUTCString();
                
                // Create RSS content
                const rssContent = `<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0">
    <channel>
        <title>Class Content: ${escapeXml(className)}</title>
        <link>${window.location.href}</link>
        <description>Content found for class '${escapeXml(className)}'</description>
        <language>en-us</language>
        <pubDate>${pubDate}</pubDate>
        <lastBuildDate>${pubDate}</lastBuildDate>
        <generator>Class Content Extractor</generator>
        <ttl>60</ttl>
        
        ${textsArray.map((text, index) => `
        <item>
            <title>Content ${index + 1}</title>
            <description>${escapeXml(text)}</description>
            <guid>item-${className}-${index}</guid>
            <pubDate>${pubDate}</pubDate>
        </item>`).join('\n        ')}
    </channel>
</rss>`;
                
                // Create blob with RSS content
                const blob = new Blob([rssContent], { 
                    type: 'application/rss+xml;charset=utf-8'
                });
                
                // Create download link
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(blob);
                downloadLink.download = `${className}-content.rss`;
                
                // Add to document, click, and remove
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // Cleanup
                URL.revokeObjectURL(downloadLink.href);
                
                // Show feedback toast
                const toast = document.createElement('div');
                toast.className = 'Toast Toast--success';
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.right = '20px';
                toast.style.zIndex = '100000';
                toast.innerHTML = `
                    <span class="Toast-icon">
                        <svg class="octicon" viewBox="0 0 16 16" width="16" height="16">
                            <path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
                        </svg>
                    </span>
                    <span class="Toast-content">Downloaded ${className}-content.rss</span>
                `;
                
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            } catch (error) {
                console.error('Download error:', error);
                alert('Failed to download RSS file. Check console for details.');
            }
        }

        function updateClassesList(classes) {
            const classesList = document.getElementById('classesList');
            const classCount = document.getElementById('classCount');
            
            if (classes.length === 0) {
                classesList.innerHTML = `
                    <div class="blankslate">
                        <p>No classes with content found</p>
                    </div>`;
                classCount.textContent = '0';
                return;
            }

            classCount.textContent = classes.length;
            
            const classesHtml = classes.map(classInfo => {
                // Prepare texts array for safe handling
                const textsJson = JSON.stringify(classInfo.texts)
                    .replace(/"/g, '&quot;');
                
                return `
                    <div class="Box-row">
                        <div class="d-flex flex-items-center justify-content-between">
                            <div class="d-flex flex-items-center flex-grow-1">
                                <span id="arrow-${classInfo.name}" 
                                       class="mr-2 color-fg-muted" 
                                       style="cursor: pointer; user-select: none;"
                                       onclick="toggleClassContent('${classInfo.name}')">▶</span>
                                <span class="Label Label--outline mr-2" 
                                      onclick="toggleClassContent('${classInfo.name}')" 
                                      style="cursor: pointer;">
                                    ${escapeXml(classInfo.name)}
                                </span>
                                <span class="Counter mr-2">${classInfo.count}</span>
                            </div>
                            <button class="btn btn-sm btn-invisible" 
                                    onclick='downloadAsRss("${escapeXml(classInfo.name)}", ${textsJson})'
                                    title="Download RSS">
                                <svg class="octicon" xmlns="http://www.w3.org/2000/svg" 
                                     viewBox="0 0 16 16" width="16" height="16">
                                    <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path>
                                    <path d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="content-${classInfo.name}" 
                             style="display: none;">
                            <div class="color-bg-subtle rounded-2 mt-2 p-3">
                                <ul class="list-style-none mb-0 text-left">
                                    ${classInfo.texts.map((text, index) => `
                                        <li class="${index !== classInfo.texts.length - 1 ? 'mb-2' : ''}">
                                            <div class="d-flex" style="align-items: flex-start;">
                                                <div class="color-fg-accent mr-2 mt-1">•</div>
                                                <div class="color-fg-muted" 
                                                     style="word-break: break-word; text-align: left; flex: 1;">
                                                    ${text}
                                                </div>
                                            </div>
                                            ${index !== classInfo.texts.length - 1 ? 
                                                '<div class="border-bottom my-2"></div>' : 
                                                ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            classesList.innerHTML = classesHtml;
        }

        function loadURL() {
            const url = document.getElementById('urlInput').value;
            if (!url) return;

            try {
                const urlObj = new URL(url);
                const frame = document.getElementById('urlFrame');
                const errorMsg = document.getElementById('errorMessage');
                const loadingMsg = document.getElementById('loadingMessage');
                const directLink = document.getElementById('directLink');

                loadingMsg.style.display = 'block';
                errorMsg.style.display = 'none';
                directLink.href = url;

                // First, fetch the HTML to extract classes
                fetch(`/proxy?url=${encodeURIComponent(url)}`)
                    .then(response => response.text())
                    .then(html => {
                        const classes = extractClasses(html);
                        updateClassesList(classes);
                    })
                    .catch(console.error);

                // Load the page in the iframe with necessary permissions
                frame.src = `/proxy?url=${encodeURIComponent(url)}`;
                frame.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-popups allow-forms');
                
                frame.onload = function() {
                    loadingMsg.style.display = 'none';
                    try {
                        // Inject styles after frame loads
                        const frameDoc = frame.contentDocument || frame.contentWindow.document;
                        injectStyles(frameDoc);
                    } catch (e) {
                        console.error('Cannot inject styles:', e);
                    }
                };

            } catch (e) {
                alert('Please enter a valid URL starting with http:// or https://');
            }
        }

        // Add event listener for Enter key
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadURL();
            }
        });
    </script>
</body>
</html> 